#!/usr/bin/env ruby
require 'lib/zabbix-benchmark'

DEFAULT_CONFIG_PATH = "conf/config.yml"

OptionParser.new do |options|
  config = BenchmarkConfig.instance

  if FileTest.exists?(DEFAULT_CONFIG_PATH)
    config.load_file(DEFAULT_CONFIG_PATH)
  end

  options.on("-u", "--uri URI") do |uri|
    config.api_uri = uri
  end

  options.on("-U", "--user USER") do |user|
    config.login_user = user
  end

  options.on("-P", "--password PASSWORD") do |pass|
    config.login_pass = pass
  end

  options.on("-n", "--num-hosts NUM_HOSTS") do |num|
    config.num_hosts = num.to_i
  end

  options.on("-s", "--hosts-step STEP") do |step|
    config.hosts_step = step.to_i
  end

  options.on("-a", "--agent ADDRESS:PORT") do |agent|
    if /(.+):(\d+)/ =~ agent
      address = $1
      port = $2.to_i
    else
      address = agent
      port = 10050
    end
    config.custom_agents.push({"ip_address" => address, "port" => port})
  end

  options.on("-l", "--zabbix-log FILE") do |file|
    config.zabbix_log_file = file
  end

  options.on("-w", "--warm-up-duration DURATION") do |duration|
    config.warm_up_duration = duration.to_i
  end

  options.on("--show-config") do
    p config
    puts ""
  end

  options.parse!(ARGV)
end

benchmark = Benchmark.new
command = ARGV[0] || "run"
benchmark.send(command)
